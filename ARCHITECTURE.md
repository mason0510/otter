# Otter 架构图

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户界面 (Next.js)                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  输入框: "把 0.1 SUI 换成 USDC，滑点 0.5%"                    │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │ 1. 发送自然语言
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Intent Layer (LLM 解析层)                        │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Claude Opus 4.5 / GPT-5.2                                   │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │  Prompt Engineering:                                    │  │  │
│  │  │  - 系统提示词 (定义支持的 Actions)                     │  │  │
│  │  │  - Few-shot Examples (转账/兑换/拆分示例)              │  │  │
│  │  │  - 结构化输出 (JSON Schema)                            │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  │  ↓ 输出                                                       │  │
│  │  {                                                            │  │
│  │    "action": "swap",                                          │  │
│  │    "params": {                                                │  │
│  │      "from_token": "SUI",                                     │  │
│  │      "to_token": "USDC",                                      │  │
│  │      "amount": "0.1",                                         │  │
│  │      "slippage": "0.5"                                        │  │
│  │    }                                                          │  │
│  │  }                                                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │ 2. 结构化意图
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Policy Layer (安全校验层)                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Token 白名单检查                                             │  │
│  │  ├─ SUI ✓                                                     │  │
│  │  ├─ USDC ✓                                                    │  │
│  │  ├─ USDT ✓                                                    │  │
│  │  └─ 其他 Token ✗ 拒绝                                        │  │
│  │                                                               │  │
│  │  参数边界检查                                                 │  │
│  │  ├─ amount > 0 且 <= 用户余额 ✓                             │  │
│  │  ├─ slippage 范围 [0.01%, 5%] ✓                             │  │
│  │  ├─ address 格式校验 (0x 开头, 64字符) ✓                    │  │
│  │  └─ 非法参数 ✗ 拒绝                                         │  │
│  │                                                               │  │
│  │  授权模式检查                                                 │  │
│  │  ├─ 检查 localStorage 是否有 auth_object_id                 │  │
│  │  ├─ 是 → 使用授权模式 (带 Authorization Object)            │  │
│  │  └─ 否 → 使用普通模式 (直接签名)                           │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │ 3. 校验通过
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  PTB Builder (交易组装层)                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  根据 action 类型组装 PTB:                                    │  │
│  │                                                               │  │
│  │  📌 Action: Transfer                                          │  │
│  │  ├─ 1. tx.splitCoins(tx.gas, [amount])                       │  │
│  │  ├─ 2. tx.moveCall(auth::execute_with_auth)                  │  │
│  │  └─ 3. tx.transferObjects([coin], recipient)                 │  │
│  │                                                               │  │
│  │  📌 Action: Swap (Cetus 集成)                                 │  │
│  │  ├─ 1. 调用 Cetus SDK 查询最优池                            │  │
│  │  │    CetusClmmSDK.Pool.fetchPools({                         │  │
│  │  │      pool_address: "0x..."                                │  │
│  │  │    })                                                     │  │
│  │  ├─ 2. 计算 sqrt_price_limit (滑点保护)                     │  │
│  │  ├─ 3. tx.splitCoins(tx.gas, [amount])                       │  │
│  │  ├─ 4. tx.moveCall(swap_wrapper::execute_swap_with_auth_v2)  │  │
│  │  │    参数: {                                                 │  │
│  │  │      auth: auth_object_id,                                │  │
│  │  │      input_coin: coin,                                    │  │
│  │  │      pool: cetus_pool_address,                            │  │
│  │  │      min_output: calculated_min_output                    │  │
│  │  │    }                                                      │  │
│  │  └─ 5. tx.transferObjects([output_coin], sender)            │  │
│  │                                                               │  │
│  │  📌 Action: Split                                             │  │
│  │  └─ tx.splitCoins(tx.gas, amounts[])                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │ 4. 完整的 PTB
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                 Transaction Preview (交易预览层)                   │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  生成人类可读的交易摘要:                                      │  │
│  │                                                               │  │
│  │  🔄 Swap 交易                                                 │  │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │
│  │  From:   0.1 SUI                                             │  │
│  │  To:     ~0.095 USDC                                         │  │
│  │  Pool:   Cetus CLMM (0x1a2b...3c4d)                          │  │
│  │  Slippage: 0.5%                                              │  │
│  │  Gas:    ~0.002 SUI                                          │  │
│  │                                                               │  │
│  │  🛡️ 授权模式                                                  │  │
│  │  此交易将使用授权对象执行，无需重复签名                       │  │
│  │                                                               │  │
│  │  [确认交易] [取消]                                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │ 5. 用户确认
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│              Wallet Interaction (@mysten/dapp-kit)                  │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  signAndExecuteTransaction({                                  │  │
│  │    transaction: ptb,                                          │  │
│  │    options: {                                                 │  │
│  │      showEffects: true,                                       │  │
│  │      showEvents: true                                         │  │
│  │    }                                                          │  │
│  │  })                                                           │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │ 6. 签名交易
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Sui Blockchain (主网)                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  合约执行流程:                                                 │  │
│  │                                                               │  │
│  │  1. swap_wrapper::execute_swap_with_auth_v2()                │  │
│  │     ├─ 调用 auth::verify_caller()                            │  │
│  │     │  检查 msg::sender == auth.agent ✓                      │  │
│  │     ├─ 调用 auth::check_and_update_auth()                    │  │
│  │     │  ├─ 检查未过期 ✓                                       │  │
│  │     │  ├─ 检查单笔限额 (0.1 <= 0.1) ✓                       │  │
│  │     │  ├─ 检查每日限额 (0.1 <= 剩余额度) ✓                  │  │
│  │     │  └─ 更新已使用额度 (daily_used += 0.1)                │  │
│  │     └─ 调用 Cetus CLMM::swap()                               │  │
│  │        执行实际兑换逻辑                                        │  │
│  │                                                               │  │
│  │  2. 返回结果:                                                  │  │
│  │     ├─ 输出 Token: Coin<USDC> (0.095 USDC)                   │  │
│  │     ├─ Gas 消耗: 0.002 SUI                                    │  │
│  │     └─ 交易哈希: 0xabc123...def789                           │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────────────┘
                            │ 7. 交易成功
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       结果展示 (UI 更新)                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  ✅ 交易成功！                                                │  │
│  │                                                               │  │
│  │  兑换结果:                                                     │  │
│  │  - 消耗: 0.1 SUI                                             │  │
│  │  - 获得: 0.095 USDC                                          │  │
│  │  - Gas: 0.002 SUI                                            │  │
│  │                                                               │  │
│  │  交易详情: https://suivision.xyz/txblock/0xabc123...         │  │
│  │                                                               │  │
│  │  授权状态:                                                     │  │
│  │  - 每日已用: 0.1 / 0.1 SUI                                   │  │
│  │  - 单笔限额: 0.1 SUI                                          │  │
│  │  - 有效期: 还剩 29 天                                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 授权模式架构（详细）

```
┌─────────────────────────────────────────────────────────────────────┐
│                     授权对象生命周期管理                            │
└─────────────────────────────────────────────────────────────────────┘

【阶段1: 创建授权】(一次性操作)
┌──────────────────────────────────────────────────────────────────┐
│  用户访问 /authorize 页面                                         │
│  ├─ 输入参数:                                                     │
│  │  - agent: 0x3724...5c3a (合约自己)                          │
│  │  - daily_limit: 0.1 SUI                                      │
│  │  - per_tx_limit: 0.1 SUI                                     │
│  │  - validity_days: 30                                         │
│  ├─ 调用合约:                                                     │
│  │  authorization::auth::create_authorization()                 │
│  └─ 返回 Shared Object ID: 0xd078...aeca                        │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────┐
│  localStorage.setItem('otter_auth_object_id', '0xd078...aeca')   │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
【阶段2: 使用授权】(多次操作)
┌──────────────────────────────────────────────────────────────────┐
│  用户执行交易 (Transfer / Swap)                                   │
│  ├─ 1. 检测到 auth_object_id 存在                                │
│  ├─ 2. PTB 中包含授权对象:                                       │
│  │     tx.moveCall({                                            │
│  │       target: 'swap_wrapper::execute_swap_with_auth_v2',    │
│  │       arguments: [                                           │
│  │         tx.object(auth_object_id),  // 授权对象              │
│  │         tx.object(input_coin),                               │
│  │         tx.pure(min_output),                                 │
│  │         tx.object(clock)                                     │
│  │       ]                                                      │
│  │     })                                                       │
│  ├─ 3. 合约自动校验:                                             │
│  │     ├─ verify_caller(): 检查 sender == auth.agent           │
│  │     ├─ check_and_update_auth():                             │
│  │     │   ├─ 未过期检查                                       │
│  │     │   ├─ 单笔限额检查                                     │
│  │     │   ├─ 每日限额检查                                     │
│  │     │   └─ 更新 daily_used 字段 (Shared Object 可修改)    │
│  │     └─ 执行实际业务逻辑                                      │
│  └─ 4. 交易成功，授权对象状态更新                                │
└──────────────────────────────────────────────────────────────────┘

【阶段3: 撤销授权】(可选)
┌──────────────────────────────────────────────────────────────────┐
│  用户访问授权管理页面 → 点击"断开授权"                           │
│  └─ localStorage.removeItem('otter_auth_object_id')             │
│  └─ 下次交易将使用普通模式                                       │
└──────────────────────────────────────────────────────────────────┘
```

---

## Cetus SDK 集成架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Cetus CLMM SDK 调用流程                          │
└─────────────────────────────────────────────────────────────────────┘

【步骤1: 初始化 SDK】
┌──────────────────────────────────────────────────────────────────┐
│  import { CetusClmmSDK } from '@cetusprotocol/cetus-sui-clmm-sdk'│
│                                                                   │
│  const sdk = new CetusClmmSDK({                                  │
│    fullRpcUrl: 'https://fullnode.mainnet.sui.io',               │
│    network: 'mainnet'                                            │
│  })                                                              │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
【步骤2: 查询池子信息】
┌──────────────────────────────────────────────────────────────────┐
│  const pools = await sdk.Pool.fetchPools({                       │
│    pool_addresses: [                                             │
│      '0x1a2b3c4d...'  // SUI-USDC 池地址                        │
│    ]                                                             │
│  })                                                              │
│                                                                   │
│  返回:                                                            │
│  {                                                               │
│    current_sqrt_price: "7905676394...",                         │
│    liquidity: "123456789",                                      │
│    tick_current_index: { bits: 253950 }                         │
│  }                                                               │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
【步骤3: 计算兑换参数】
┌──────────────────────────────────────────────────────────────────┐
│  const preSwapResult = sdk.Swap.preswap({                        │
│    pool: pools[0],                                               │
│    current_sqrt_price: pools[0].current_sqrt_price,             │
│    coinTypeA: 'SUI',                                             │
│    coinTypeB: 'USDC',                                            │
│    decimalsA: 9,                                                 │
│    decimalsB: 6,                                                 │
│    a2b: true,  // SUI → USDC                                    │
│    by_amount_in: true,                                           │
│    amount: '100000000'  // 0.1 SUI                              │
│  })                                                              │
│                                                                   │
│  返回:                                                            │
│  {                                                               │
│    estimatedAmountOut: '95000',  // 预计获得 0.095 USDC        │
│    estimatedFeeAmount: '500',                                    │
│    isExceed: false                                               │
│  }                                                               │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         ▼
【步骤4: 构造 PTB (集成到 Otter)】
┌──────────────────────────────────────────────────────────────────┐
│  const tx = new TransactionBlock()                               │
│                                                                   │
│  // 拆分输入 Coin                                                 │
│  const [inputCoin] = tx.splitCoins(tx.gas, [tx.pure(amount)])   │
│                                                                   │
│  // 调用 Otter 合约的 Swap Wrapper (包装 Cetus 调用)            │
│  tx.moveCall({                                                   │
│    target: `${PACKAGE_ID}::swap_wrapper::execute_swap_with_auth_v2`,│
│    arguments: [                                                  │
│      tx.object(authObjectId),      // 授权对象                   │
│      inputCoin,                    // 输入 Coin                  │
│      tx.pure(minOutput),           // 最小输出 (滑点保护)        │
│      tx.object('0x6'),             // Clock                     │
│    ],                                                            │
│    typeArguments: [SUI_TYPE, USDC_TYPE]                         │
│  })                                                              │
│                                                                   │
│  // 合约内部会调用:                                              │
│  // cetus_clmm::pool::swap_with_partner(...)                    │
└──────────────────────────────────────────────────────────────────┘
```

---

## 技术栈层级图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          前端层 (Next.js 15)                        │
│  ┌──────────────┬──────────────┬──────────────┬─────────────────┐  │
│  │  React 19    │  TypeScript  │  Tailwind    │  @mysten/dapp-  │  │
│  │              │              │  CSS         │  kit            │  │
│  └──────────────┴──────────────┴──────────────┴─────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        AI 推理层 (第三方 API)                       │
│  ┌──────────────┬──────────────┬──────────────────────────────┐   │
│  │  Claude      │  GPT-5.2     │  结构化输出                   │   │
│  │  Opus 4.5    │              │  (JSON Schema)                │   │
│  └──────────────┴──────────────┴──────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      业务逻辑层 (TypeScript)                        │
│  ┌──────────────┬──────────────┬──────────────┬─────────────────┐  │
│  │  Intent      │  Policy      │  PTB         │  Transaction    │  │
│  │  Parser      │  Validator   │  Builder     │  Preview        │  │
│  └──────────────┴──────────────┴──────────────┴─────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Sui SDK 层 (@mysten/sui.js)                   │
│  ┌──────────────┬──────────────┬──────────────────────────────┐   │
│  │  Transaction │  SuiClient   │  钱包连接                     │   │
│  │  Block       │              │  (signTransaction)            │   │
│  └──────────────┴──────────────┴──────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  Cetus SDK 层 (Cetus CLMM SDK)                      │
│  ┌──────────────┬──────────────┬──────────────────────────────┐   │
│  │  Pool Query  │  Swap        │  Price                        │   │
│  │              │  Calculator  │  Oracle                       │   │
│  └──────────────┴──────────────┴──────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      智能合约层 (Move 2024)                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  authorization::auth                                          │  │
│  │  ├─ create_authorization()                                    │  │
│  │  ├─ verify_caller()                                           │  │
│  │  ├─ check_and_update_auth()                                   │  │
│  │  └─ execute_with_auth()                                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  swap_wrapper                                                 │  │
│  │  └─ execute_swap_with_auth_v2()                               │  │
│  │     └─ 调用 cetus_clmm::pool::swap_with_partner()            │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Sui 区块链层 (Mainnet)                           │
│  ┌──────────────┬──────────────┬──────────────────────────────┐   │
│  │  共识层      │  执行层      │  存储层                       │   │
│  │  (Narwhal)   │  (Move VM)   │  (Object Store)               │   │
│  └──────────────┴──────────────┴──────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 数据流图 (从输入到输出)

```
自然语言
"把 0.1 SUI 换成 USDC，滑点 0.5%"
          │
          │ [Intent Layer]
          ▼
结构化意图 (JSON)
{
  action: "swap",
  params: {
    from: "SUI",
    to: "USDC",
    amount: "0.1",
    slippage: "0.5"
  }
}
          │
          │ [Policy Layer]
          ▼
校验通过的参数
✓ SUI 在白名单
✓ USDC 在白名单
✓ amount > 0
✓ slippage ∈ [0.01%, 5%]
          │
          │ [Cetus SDK]
          ▼
最优池信息
Pool: 0x1a2b...3c4d
Current Price: 0.95 USDC/SUI
Estimated Output: 0.095 USDC
          │
          │ [PTB Builder]
          ▼
可编程交易块
1. splitCoins(0.1 SUI)
2. swap_with_auth(auth, coin, 0.095 USDC min)
3. transferObjects(output, sender)
          │
          │ [Wallet]
          ▼
用户签名
签名哈希: 0xabc123...def789
          │
          │ [Sui Blockchain]
          ▼
链上执行
✓ 授权校验通过
✓ 兑换成功
✓ Gas 消耗: 0.002 SUI
          │
          │ [Result]
          ▼
交易结果
消耗: 0.1 SUI
获得: 0.095 USDC
状态: Success ✅
```

---

## 核心优势总结

| 维度 | 传统 DeFi | Otter 方案 |
|------|----------|-----------|
| **交互方式** | 表单填写 + 下拉选择 | 自然语言输入 |
| **交易次数** | 多次签名（兑换+拆分+转账 = 3笔） | 一次签名完成 |
| **交易透明度** | 黑盒（不知道签的是什么） | 人类可读摘要 + 明细 |
| **安全性** | 依赖用户判断 | LLM + Policy 双层防护 |
| **学习成本** | 需要理解合约/SDK（1-2周） | 零门槛（会说话就会用） |
| **错误率** | 高（地址输错、数量输错） | 低（AI 自动校验） |
| **可扩展性** | 每个 DApp 独立开发 | 统一意图解析层 |

